# Myrient DAT Downloader Optimized (dltool_optimized)

A Python script to automatically download ROMs/files from [Myrient](https://myrient.erista.me/files/) based on DAT files (such as those generated by No-Intro, Redump, etc.).

This script (`dltool_optimized.py`) is a significantly revised and improved version, forked and enhanced from the original `dltool.py` by [kosmosnautti](https://github.com/kosmosnautti/dltool).

## Main Features

* **DAT File Analysis:** Reads XML-formatted DAT files to extract the list of desired games/sets.
* **Interaction with Myrient:**
    * Navigates Myrient's directories to identify catalogs (e.g., No-Intro, Redump).
    * Searches for and selects the specific system collection (e.g., "Nintendo - Game Boy Advance", "Commodore - Amiga").
* **Automatic and Manual Selection:**
    * Attempts to automatically identify the catalog and collection based on information in the DAT file header and Myrient's structure.
    * Provides command-line options (`-c`, `-s`) to force manual selection if automatic selection fails or is not desired.
* **Advanced Download Logic:**
    * Downloads missing files to the specified output folder.
    * **Existing File Management:**
        * `--skip-existing` option: If a file with the same name already exists in the destination folder, the download is skipped regardless of size.
        * Default behavior (without `--skip-existing`):
            * If the local file exists and has the **same size** as the remote file, it is skipped.
            * If the local file exists and is **smaller** than the remote file, the download is **resumed** (if the server supports the HTTP Range header).
            * If the local file exists and is **larger** than the remote file (or if the remote size cannot be obtained), the local file is **overwritten** with a new full download.
* **Output Folder Creation:**
    * The output folder parameter (`-o`) is optional.
    * If omitted, the script automatically creates a subfolder named after the Myrient collection (sanitized) in the same directory as the script.
* **User Interface:**
    * Colored and timestamped output for better readability and operation tracking.
    * Detailed progress bar (`progressbar2`) for each download, showing percentage, transferred data, speed, and estimated time remaining (ETA).
    * "List only" mode (`-l`): Allows checking which files are missing without downloading anything.
* **Robustness:**
    * Management of network errors (timeouts, HTTP errors) and parsing errors.
    * Controlled exit and clear messages in case of user interruption (Ctrl+C).

## Prerequisites

* **Python 3.x**
* The following Python libraries (installable via `pip`):
    * `requests` (for HTTP requests)
    * `beautifulsoup4` (for parsing HTML of Myrient pages)
    * `progressbar2` (for displaying download progress bars)

## Dependency Installation

You can install the necessary libraries using `pip` (it is recommended to do this within a Python virtual environment):

```bash
pip install requests beautifulsoup4 progressbar2
```

## Usage

Run the script from a terminal or command prompt:

```bash
python dltool_optimized.py -i <file.dat> [OPTIONAL_PARAMETERS]
```

### Command-Line Parameters

* **Required Parameters:**
    * `-i <file.dat>`: Specifies the path to your input DAT file (e.g., `Nintendo - Nintendo Entertainment System.dat`).

* **Optional Parameters:**
    * `-o <output_folder>`: Specifies the folder where downloaded files will be saved.
        * **Default Behavior if Omitted:** The script will automatically create a subfolder named after the system/collection (e.g., `./Nintendo - Nintendo Entertainment System/`) in the same directory where the script is located.
    * `-c`: **Force manual catalog choice.** Prompts the user to manually choose the catalog (e.g., "No-Intro", "Redump") from the presented list, even if the script believes it has identified it automatically from the DAT file.
    * `-s`: **Force manual system/collection choice.** Prompts the user to manually choose the specific collection (e.g., "Nintendo - Game Boy Advance") from the presented list, even if the script believes it has identified it automatically.
    * `-l`: **List missing only (No download).** Performs a scan and comparison of files in the DAT against those on the Myrient server, but instead of downloading files, it only lists which ROMs/files from the DAT were *not* found (or do not match) in the selected Myrient collection.
    * `--skip-existing`: **Skip existing files.** If this option is specified, the script will not attempt to re-download a file if it already exists in the destination folder, regardless of its size. If not specified, the script will compare sizes to decide whether to resume, skip, or re-download (see "Advanced Download Logic").
    * `-h` or `--help`: **Show Help.** Displays a detailed help message with a description of all parameters and their usage.

## Usage Examples

1.  **Basic download, specifying the output folder (compares sizes for existing files):**

    ```bash
    python dltool_optimized.py -i "Sony - PlayStation.dat" -o "/media/roms/PlayStation"
    ```

2.  **Download with automatic output folder creation, skipping any already existing files in the destination:**

    ```bash
    python dltool_optimized.py -i "Commodore - Amiga.dat" --skip-existing
    ```
    *(If the chosen collection is "Commodore - Amiga", files will be downloaded to a subfolder named `./Commodore - Amiga/`. If a file with the same name is already present in that folder, it will be skipped without checking the size).*

3.  **Only check for missing files for a given DAT, without downloading anything:**

    ```bash
    python dltool_optimized.py -i "Sega - Mega Drive - Genesis.dat" -l
    ```

4.  **Force manual selection of the system/collection:**

    ```bash
    python dltool_optimized.py -i "My Custom System.dat" -s
    ```

## Key Enhancements Over Original `kosmosnautti/dltool`

This script (`dltool_optimized.py`) builds upon the foundation of the original `dltool.py` by [kosmosnautti](https://github.com/kosmosnautti/dltool) with several key enhancements and bug fixes:

* **Game Name Handling (Bug Fix):** Corrected a critical issue where game names from the DAT file containing periods (e.g., in version numbers like "v1.02" or abbreviations like "S.T.U.N.") were erroneously truncated. This caused mismatches with files on Myrient. Our version now reads and compares these names correctly.
* **Optional Output Path (`-o`):** The output directory is now optional. If not specified, a directory named after the selected Myrient collection is automatically created in the script's location. The original required `-o`.
* **Advanced File Existence and Download Logic:**
    * Introduced the `--skip-existing` flag for a straightforward way to avoid re-downloading any file that already exists locally, useful when downloading for example, ISO files against a bunch of already downloaded CHD files.
    * The default behavior (without `--skip-existing`) provides more nuanced handling: exact size match skips, smaller local size resumes, and larger local size (or unknown remote size) overwrites. The original had a less defined resume capability.
* **Improved Robustness and Error Handling:**
    * More comprehensive error checking during XML (DAT) and HTML (Myrient page) parsing.
    * Explicit HTTP error checking (`resp.raise_for_status()`) and defined timeouts for network requests.
* **Enhanced User Interface and Logging:**
    * Timestamped and colored log messages for better clarity.
    * Log line rewriting for cleaner status updates (e.g., "Checking..." replaced by "Downloaded...").
    * Uses `progressbar2` for a more feature-rich progress bar display during downloads, compared to the older `progressbar` library likely used by the original.
* **Code Structure and Maintainability:**
    * Refactored into more helper functions (e.g., `logger`, `inputter`, `scale1024`, `sanitize_filename`) for better organization.
    * More constants defined for clarity.
* **Directory Name Sanitization:** Includes a function (`sanitize_filename`) to ensure that directory names created from Myrient collection titles are valid across different operating systems.
* **Path Handling:** Uses `os.path.join`, `os.path.abspath`, and `os.path.normpath` for more robust cross-platform path management.

## Known Limitations

* **Dependency on Myrient's HTML Structure:** The script relies on the current HTML structure of the Myrient website to find links to files and directories. Significant changes to the site's layout could break the script's functionality until it is updated to reflect those changes.
* **Reliability of Automatic Selection:** Automatic determination of the catalog and system/collection is based on heuristics (string matching in names and URLs). It might not work correctly for DAT files with unusual formatting or names, or if the names on Myrient differ significantly. In such cases, using the manual selection options (`-c` and `-s`) is recommended.

---
**Original Project:** This script is a fork and has been significantly modified from the original `dltool` by kosmosnautti. You can find the original project at [https://github.com/kosmosnautti/dltool](https://github.com/kosmosnautti/dltool).
